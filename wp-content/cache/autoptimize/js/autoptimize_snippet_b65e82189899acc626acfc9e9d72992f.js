(function($){"use strict";window.etCore.portability=$.extend(etCorePortability,{cancelled:false,boot:function($instance){var $this=this;var $customizeHeader=$('#customize-header-actions');var $customizePortability=$('.et-core-customize-controls-close');if($customizeHeader.length&&$customizePortability.length){$customizeHeader.append($customizePortability);}
$('[data-et-core-portability]').each(function(){$this.listen($(this));});etCorePortability=null;},listen:function($el){var $this=this;$el.find('[data-et-core-portability-export]').click(function(e){e.preventDefault();if(!$this.actionsDisabled()){$this.disableActions();$this.export();}});$el.find('.et-core-portability-export-form input[type="text"]').on('keydown',function(e){if(13===e.keyCode){e.preventDefault();$el.find('[data-et-core-portability-export]').click();}});$el.find('.et-core-portability-import-form input[type="file"]').on('change',function(e){$this.populateImport($(this).get(0).files[0]);});$el.find('.et-core-portability-import').click(function(e){e.preventDefault();if(!$this.actionsDisabled()){$this.disableActions();$this.import();}});$el.find('.et-core-portability-import-form button').click(function(e){e.preventDefault();$this.instance('input[type="file"]').trigger('click');});$el.find('[data-et-core-portability-cancel]').click(function(e){e.preventDefault();$this.cancel();})},validateImportFile:function(file,noOutput){if(undefined!==file&&'undefined'!=typeof file.name&&'undefined'!=typeof file.type&&'json'==file.name.split('.').slice(-1)[0]){return true;}
if(!noOutput){etCore.modalContent('<p>'+this.text.invalideFile+'</p>',false,3000,'#et-core-portability-import');}
this.enableActions();return false;},populateImport:function(file){if(!this.validateImportFile(file)){return;}
$('.et-core-portability-import-placeholder').text(file.name);},import:function(noBackup){var $this=this,file=$this.instance('input[type="file"]').get(0).files[0];if(undefined===window.FormData){etCore.modalContent('<p>'+this.text.browserSupport+'</p>',false,3000,'#et-core-portability-import');$this.enableActions();return;}
if(!$this.validateImportFile(file)){return;}
$this.addProgressBar($this.text.importing);if($this.instance('[name="et-core-portability-import-backup"]').is(':checked')&&!noBackup){$this.export(true);$($this).on('exported',function(){$this.import(true);});return;}
$this.ajaxAction({action:'et_core_portability_import',file:file,nonce:$this.nonces.import},function(response){etCore.modalContent('<div class="et-core-loader et-core-loader-success"></div>',false,3000,'#et-core-portability-import');$this.toggleCancel();$(document).delay(3000).queue(function(){etCore.modalContent('<div class="et-core-loader"></div>',false,false,'#et-core-portability-import');$(this).dequeue().delay(2000).queue(function(){if('undefined'!==typeof response.data.postContent){var save=$('#save-action #save-post');if(save.length===0){save=$('#publishing-action input[type="submit"]');}
if('undefined'!==typeof window.tinyMCE&&window.tinyMCE.get('content')&&!window.tinyMCE.get('content').isHidden()){var editor=window.tinyMCE.get('content');editor.setContent($.trim(response.data.postContent),{format:'html'});}else{$('#content').val($.trim(response.data.postContent));}
save.trigger('click');window.onbeforeunload=function(){$('body').fadeOut(500);}}else{$('body').fadeOut(500,function(){$(window).unbind('beforeunload');window.location=window.location.href.replace(/reset\=true\&|\&reset\=true/,'');})}});});},true);},export:function(backup){var $this=this,progressBarMessages=backup?$this.text.backuping:$this.text.exporting;$this.save(function(){var posts={},content=false;if($this.instance('[name="et-core-portability-posts"]').is(':checked')){$('#posts-filter [name="post[]"]:checked:enabled').each(function(){posts[this.id]=this.value;});if($.isEmptyObject(posts)){etCore.modalContent('<div class="et-core-loader et-core-loader-fail"></div><h3>'+$this.text.noItemsSelected+'</h3>',false,true,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));$this.enableActions();return;}}
$this.addProgressBar(progressBarMessages);if('undefined'!==typeof window.tinyMCE&&window.tinyMCE.get('content')&&!window.tinyMCE.get('content').isHidden()){content=window.tinyMCE.get('content').getContent();}else if($('textarea#content').length>0){content=$('textarea#content').val();}
if(false!==content){content=content.replace(/^([^\[]*){1}/,'');content=content.replace(/([^\]]*)$/,'');}
$this.ajaxAction({action:'et_core_portability_export',content:content,selection:$.isEmptyObject(posts)?false:JSON.stringify(posts),nonce:$this.nonces.export},function(response){var time=' '+new Date().toJSON().replace('T',' ').replace(':','h').substring(0,16),downloadURL=$this.instance('[data-et-core-portability-export]').data('et-core-portability-export'),query={'timestamp':response.data.timestamp,'name':encodeURIComponent($this.instance('.et-core-portability-export-form input').val()+(backup?time:'')),};$.each(query,function(key,value){if(value){downloadURL=downloadURL+'&'+key+'='+value;}});$(window).unbind('beforeunload');window.location.assign(encodeURI(downloadURL));if(!backup){etCore.modalContent('<div class="et-core-loader et-core-loader-success"></div>',false,3000,'#et-core-portability-export');$this.toggleCancel();}
$($this).trigger('exported');});});},exportFB:function(exportUrl,postId,content,fileName,importFile,page){var $this=this;page=typeof page==='undefined'?1:page;$.ajax({type:'POST',url:etCore.ajaxurl,dataType:'json',data:{action:'et_core_portability_export',content:content,timestamp:0,nonce:$this.nonces.export,post:postId,context:'et_builder',page:page,},success:function(response){var errorEvent=document.createEvent('Event');errorEvent.initEvent('et_fb_layout_export_error',true,true);if('string'===typeof response&&'0'===response){window.et_fb_export_layout_message=$this.text.maxSizeExceeded;window.dispatchEvent(errorEvent);return;}
else if('string'===typeof response&&response.toLowerCase().indexOf('memory size')>=0){window.et_fb_export_layout_message=$this.text.memoryExhausted;window.dispatchEvent(errorEvent);return;}
else if('undefined'!==typeof response.page){if($this.cancelled){return;}
return $this.exportFB(exportUrl,postId,content,fileName,importFile,(page+1));}else if('undefined'!==typeof response.data&&'undefined'!==typeof response.data.message){window.et_fb_export_layout_message=$this.text[response.data.message];window.dispatchEvent(errorEvent);return;}
var time=' '+new Date().toJSON().replace('T',' ').replace(':','h').substring(0,16),downloadURL=exportUrl,query={'timestamp':response.data.timestamp,'name':''!==fileName?fileName:encodeURIComponent(time),};$.each(query,function(key,value){if(value){downloadURL=downloadURL+'&'+key+'='+value;}});$(window).unbind('beforeunload');window.location.assign(encodeURI(downloadURL));if(typeof importFile!=='undefined'){$this.importFB(importFile,postId);}else{var event=document.createEvent('Event');event.initEvent('et_fb_layout_export_finished',true,true);window.dispatchEvent(event);}}});},importFB:function(file,postId){var $this=this;var errorEvent=document.createEvent('Event');window.et_fb_import_progress=0;window.et_fb_import_estimation=1;errorEvent.initEvent('et_fb_layout_import_error',true,true);if(undefined===window.FormData){window.et_fb_import_layout_message=this.text.browserSupport;window.dispatchEvent(errorEvent);return;}
if(!$this.validateImportFile(file,true)){window.et_fb_import_layout_message=this.text.invalideFile;window.dispatchEvent(errorEvent);return;}
var fileSize=Math.ceil((file.size/(1024*1024)).toFixed(2)),formData=new FormData(),requestData={action:'et_core_portability_import',file:file,content:false,timestamp:0,nonce:$this.nonces.import,post:postId,context:'et_builder'};if(fileSize>=$this.postMaxSize||fileSize>=$this.uploadMaxSize){window.et_fb_import_layout_message=this.text.maxSizeExceeded;window.dispatchEvent(errorEvent);return;}
$.each(requestData,function(name,value){formData.append(name,value);});var importFBAjax=function(importData){$.ajax({type:'POST',url:etCore.ajaxurl,processData:false,contentType:false,data:formData,success:function(response){var event=document.createEvent('Event');event.initEvent('et_fb_layout_import_in_progress',true,true);if(!response.success&&'undefined'!==typeof response.data&&'undefined'!==typeof response.data.message&&'undefined'!==typeof $this.text[response.data.message]){window.et_fb_import_layout_message=$this.text[response.data.message];window.dispatchEvent(errorEvent);}
else if('string'===typeof response&&('0'===response||''===response)){window.et_fb_import_layout_message=$this.text.maxSizeExceeded;window.dispatchEvent(errorEvent);return;}
else if('string'===typeof response&&response.toLowerCase().indexOf('memory size')>=0){window.et_fb_import_layout_message=$this.text.memoryExhausted;window.dispatchEvent(errorEvent);return;}
else if('undefined'!==typeof response.page&&'undefined'!==typeof response.total_pages){var progress=Math.ceil((response.page*100)/response.total_pages);var estimation=Math.ceil(((response.total_pages-response.page)*6)/60);window.et_fb_import_progress=progress;window.et_fb_import_estimation=estimation;var nextImportData=importData;nextImportData.append('page',(parseInt(response.page)+1));nextImportData.append('timestamp',response.timestamp);nextImportData.append('file',null);importFBAjax(nextImportData);window.dispatchEvent(event);}else{window.et_fb_import_progress=100;window.et_fb_import_estimation=0;window.dispatchEvent(event);setTimeout(function(){var event=document.createEvent('Event');event.initEvent('et_fb_layout_import_finished',true,true);window.et_fb_import_layout_response=response;window.dispatchEvent(event);},1300);}}});};importFBAjax(formData)},ajaxAction:function(data,callback,fileSupport){var $this=this;this.cancelled=false;data=$.extend({nonce:$this.nonce,file:null,content:false,timestamp:0,post:$('#post_ID').val(),context:$this.instance().data('et-core-portability'),page:1,},data);var ajax={type:'POST',url:etCore.ajaxurl,data:data,success:function(response){if('string'===typeof response&&'0'===response){etCore.modalContent('<p>'+$this.text.maxSizeExceeded+'</p>',false,true,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));$this.enableActions();return;}
else if('string'===typeof response&&response.toLowerCase().indexOf('memory size')>=0){etCore.modalContent('<p>'+$this.text.memoryExhausted+'</p>',false,true,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));$this.enableActions();return;}
else if('undefined'!==typeof response.page){var progress=Math.ceil((response.page*100)/response.total_pages);if($this.cancelled){return;}
$this.toggleCancel(true);$this.ajaxAction($.extend(data,{page:parseInt(response.page)+1,timestamp:response.timestamp,file:null,}),callback,false);$this.instance('.et-core-progress-bar').width(progress+'%').text(progress+'%');$this.instance('.et-core-progress-subtext span').text(Math.ceil(((response.total_pages-response.page)*6)/60));return;}else if('undefined'!==typeof response.data&&'undefined'!==typeof response.data.message){etCore.modalContent('<p>'+$this.text[response.data.message]+'</p>',false,3000,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));$this.enableActions();return;}
var ajax_returned_timestamp=new Date().getTime();var animateCoreProgressBar=function(DOMHighResTimeStamp){var current_timestamp=new Date().getTime();if((current_timestamp-ajax_returned_timestamp)>3000){$this.enableActions();etCore.modalContent('<div class="et-core-loader et-core-loader-fail"></div>',false,3000,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));return;}
if($this.instance('.et-core-progress').length){$this.instance('.et-core-progress').removeClass('et-core-progress-striped').find('.et-core-progress-bar').width('100%').text('100%').delay(1000).queue(function(){$this.enableActions();if('undefined'===typeof response.data||('undefined'!==typeof response.data&&!response.data.timestamp)){etCore.modalContent('<div class="et-core-loader et-core-loader-fail"></div>',false,3000,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));return;}
$(this).dequeue();callback(response);});}else{window.requestAnimationFrame(animateCoreProgressBar);}}
animateCoreProgressBar();}};if(fileSupport){var fileSize=Math.ceil((data.file.size/(1024*1024)).toFixed(2)),formData=new FormData();if(fileSize>=$this.postMaxSize||fileSize>=$this.uploadMaxSize){etCore.modalContent('<p>'+$this.text.maxSizeExceeded+'</p>',false,true,'#'+$this.instance('.ui-tabs-panel:visible').attr('id'));$this.enableActions();return;}
$.each(ajax.data,function(name,value){formData.append(name,value);});ajax=$.extend(ajax,{data:formData,processData:false,contentType:false,});}
$.ajax(ajax);},save:function(callback){if('undefined'!==typeof wp&&'undefined'!==typeof wp.customize){var saveCallback=function(){callback();wp.customize.unbind('saved',saveCallback);}
$('#save').click();wp.customize.bind('saved',saveCallback);}else{setTimeout(function(){callback();},1000)}},addProgressBar:function(message){etCore.modalContent('<div class="et-core-progress et-core-progress-striped et-core-active"><div class="et-core-progress-bar" style="width: 10%;">1%</div><span class="et-core-progress-subtext">'+message+'</span></div>',false,false,'#'+this.instance('.ui-tabs-panel:visible').attr('id'));},actionsDisabled:function(){if(this.instance('.et-core-modal-action').hasClass('et-core-disabled')){return true;}
return false;},disableActions:function(){this.instance('.et-core-modal-action').addClass('et-core-disabled');},enableActions:function(){this.instance('.et-core-modal-action').removeClass('et-core-disabled');},toggleCancel:function(cancel){var $target=this.instance('.ui-tabs-panel:visible [data-et-core-portability-cancel]');if(cancel&&!$target.is(':visible')){$target.show().animate({opacity:1},600);}else if(!cancel&&$target.is(':visible')){$target.animate({opacity:0},600,function(){$(this).hide();});}},cancel:function(cancel){this.cancelled=true;setTimeout(function(){$.ajax({type:'POST',url:etCore.ajaxurl,data:{nonce:this.nonces.cancel,context:this.instance().data('et-core-portability'),action:'et_core_portability_cancel',}});}.bind(this),3000);etCore.modalContent('<div class="et-core-loader et-core-loader-success"></div>',false,3000,'#'+this.instance('.ui-tabs-panel:visible').attr('id'));this.toggleCancel();this.enableActions();},instance:function(element){return $('.et-core-active[data-et-core-portability]'+(element?' '+element:''));},});$(document).ready(function(){window.etCore.portability.boot();});})(jQuery);